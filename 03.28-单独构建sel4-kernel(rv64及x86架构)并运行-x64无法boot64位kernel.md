# sel4的文档阅读-单独构建sel4 kernel-qemu运行-x64无法boot64位kernel

文档官网：[seL4 Docs | seL4 docs](https://docs.sel4.systems/)。

## 单独构建sel4 kernel

参考：[Stand-alone seL4 builds | seL4 docs](https://docs.sel4.systems/projects/buildsystem/standalone.html)。

在我的sel4-12.1.0文件夹同级目录下，建立build文件夹并进入

```
mkdir build && cd build
```

然后输入cmake命令，编译，要修改官网的文件夹名

```
cmake -DCROSS_COMPILER_PREFIX= -DCMAKE_TOOLCHAIN_FILE=../seL4-12.1.0/gcc.cmake -G Ninja -C ../seL4-12.1.0/configs/X64_verified.cmake ../seL4-12.1.0/
```

* 如果是rv架构：

```
cmake -DCROSS_COMPILER_PREFIX=riscv64-unknown-linux-gnu- -DCMAKE_TOOLCHAIN_FILE=../seL4-12.1.0/gcc.cmake -G Ninja -C ../seL4-12.1.0/configs/RISCV64_verified.cmake ../seL4-12.1.0/
```

注意此处要修改文件kernel/tools/circular_includes.py：[seL4 fails to compile, circular_includes_valid fails · Issue #374 · seL4/seL4 (github.com)](https://github.com/seL4/seL4/issues/374).

ninja命令打包出kernel：

```
ninja kernel.elf
```

![image-20220302160305101](images/03.02-sel4%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB.assets/image-20220302160305101.png)

后文讲到：

![image-20220302160526579](images/03.02-sel4%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB.assets/image-20220302160526579.png)

BootLoader和应用程序需要了解系统配置，kernel才能运行。

将此程序与cbuild文件夹下的kernel.elf对比，并不相同？？？待解决

![image-20220302222405546](images/03.02-sel4%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB.assets/image-20220302222405546.png)



## qemu运行它的效果

```
qemu-system-x86_64 -cpu Nehalem,-vme,+pdpe1gb,-xsave,-xsaveopt,-xsavec,-fsgsbase,-invpcid,+syscall,+lm,enforce -serial mon:stdio -m size=3G  -kernel kernel.elf
```

![image-20220302163109075](images/03.02-sel4%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB.assets/image-20220302163109075.png)

[论坛](https://forum.osdev.org/viewtopic.php?f=1&t=26312)上说，qemu模拟的x86，以及实际的机器，都不支持64位的image。用file命令查看，确实是64的：

![image-20220302200251271](images/03.02-sel4%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB.assets/image-20220302200251271.png)

但是测试程序中是32位的：

![85536b952bcf35827bce5cf4881168a](images/03.02-sel4%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB.assets/85536b952bcf35827bce5cf4881168a.png)

## x64 无法用-kernel boot，我们能否boot IA32架构？

那么，能否编译出32位架构的image呢？上文说到，cmake命令中包含 `seL4-12.1.0/configs/X64_verified.cmake`文件夹下的`X64_verified.cmake`文件，但是同文件夹下还有个~~奇怪~~的东西，就是它：

![image-20220302164035934](images/03.02-sel4%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB.assets/image-20220302164035934.png)

内容也与其他文件不同，如果编译时指定它`cmake -DCROSS_COMPILER_PREFIX= -DCMAKE_TOOLCHAIN_FILE=../seL4-12.1.0/gcc.cmake -G Ninja -C ../seL4-12.1.0/configs/seL4Config.cmake ../seL4-12.1.0/`是无效的，它好像是别的文件相关联，但是打开它可以看到一些信息，这里提到了IA32架构，但是没给单独的cmake文件？是不是未经过验证。

![image-20220302170923214](images/03.02-sel4%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB.assets/image-20220302170923214.png)

不管它，创建个IA32.cmake文件，把x64文件的内容复制进来，修改架构为IA32：

![image-20220302171103792](images/03.02-sel4%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB.assets/image-20220302171103792.png)

然后创建ia32build文件夹，cd，再次cmake，cmake和ninja打包，cmake命令如下：

```
cmake -DCROSS_COMPILER_PREFIX= -DCMAKE_TOOLCHAIN_FILE=../seL4-12.1.0/gcc.cmake -G Ninja -C ../seL4-12.1.0/configs/IA32.cmake ../seL4-12.1.0/
```

倒是没有报错：

![image-20220302171145209](images/03.02-sel4%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB.assets/image-20220302171145209.png)

运行试试：

```
qemu-system-x86_64 -cpu Nehalem,-vme,+pdpe1gb,-xsave,-xsaveopt,-xsavec,-fsgsbase,-invpcid,+syscall,+lm,enforce -m size=3G  -kernel kernel.elf
```

此处没有BootLoader，只能说，初步检查，可以装载IA32的kernel，具体能否运行成功，还需要BootLoader。

![image-20220302171548279](images/03.02-sel4%E6%96%87%E6%A1%A3%E9%98%85%E8%AF%BB.assets/image-20220302171548279.png)

现在面临的问题是：

* 32位kernel就算有BootLoader，但它未经过验证，能够使用？
* 能否boot 64位的kernel？[Booting from Grub2 to x86 long mode (64-bit mode)](http://ringzeroandlower.com/2017/08/08/x86-64-kernel-boot.html)，看到这文章，但是先不看了，就算无法boot 64位的kernel，也可以学到BootLoader。

应该是把64位的kernel.elf搞成32bit的镜像，[这里的工具](https://www.cnblogs.com/Oude/articles/12039025.html)可能有帮助，然后龙芯机器上，让BootLoader去boot这个32bit镜像。

所以要装一下支持龙芯的qemu？看能否启动64位内核？

附：[引导加载程序（BootLoader）介绍](https://blog.csdn.net/sinat_31608641/article/details/109981978)。
