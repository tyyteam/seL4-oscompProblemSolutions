

[Linux 2.6 内核引导过程分析 - - ITeye博客](https://www.iteye.com/blog/david05software-775255)。

简书博客：[seL4内核启动分析 - 简书 (jianshu.com)](https://www.jianshu.com/p/f741d26de6c4)。

# x86启动过程分析

系统入口？

_start: src/arch/x86/64/head.S:269

common_init: src/arch/x86/64/head.S:247

setup_pml4： src/arch/x86/64/head.S:71

huge_page_check： src/arch/x86/64/head.S:53-->setup_pml4-->common_init

enable_x64_mode： src/arch/x86/64/head.S:217-->common_init

syscall_enable：src/arch/x86/64/head.S:206

syscall_check：src/arch/x86/64/head.S:163-->syscall_enable-->common_init-->_start

_start64：src/arch/x86/64/head.S:297

_entry_64：src/arch/x86/64/head.S：335

修改了rax的值，修改了rsp,rbp的值，好像与kernel有关

boot_sys：src/arch/x86/kernel/boot_sys.c:707

try_boot_sys_mbi1：src/arch/x86/kernel/boot_sys.c:517-->boot_sys

schedule：src/arch/x86/kernel/boot_sys.c：734

# rv启动过程分析

编译流程参见陈洋写的：[seL4Test RISC-V qemu模拟](https://github.com/tyyteam/seL4-oscompProblemSolutions/blob/chenyang/2022.3.21 seL4Test RISC-V qemu模拟.md)。

两个gdb窗口的参数：

```
qemu-system-riscv64 -machine spike -cpu rv64 -nographic -serial mon:stdio -m size=4095M -S -s -kernel images/sel4test-driver-image-riscv-spike -bios none
```

```
riscv64-unknown-linux-gnu-gdb images/sel4test-driver-image-riscv-spike#调试fw，目前乱跳
riscv64-unknown-linux-gnu-gdb kernel/kernel.elf#调试内核，断点从init_kernel开始
target remote:1234
b init_kernel
tui enable
```

在调试窗口中，查看文件断点信息和其他一些内容

第一个入口点信息。其他是段信息和地址。段的参考博客：[浅谈程序中的text段、data段和bss段](https://zhuanlan.zhihu.com/p/28659560?utm_source=qq&utm_medium=social&utm_oi=816085675953750016)。[.text .data .bss .stack .heap 详解](https://blog.csdn.net/phenixyf/article/details/116718762#:~:text=data %2F bss %2F text %3A text 段在内存中被映射为只读，但.data,和.bss 是可写的。 bss 是英文Block Sta rted by Symbol的简称，通常是指用来存放程序中未初始化的全局变量的一块内存区域，在程序载入时由内核清0。)。

* .text：存放程序代码的内容。

* .rodata：存放常量数据。

* .data：已经初始化的全局变量，属于静态内存分配
* .htif：hart interface，riscv用于与主机交互的部分。
* .bss：存放没有初始值的全局变量。
* .payload：

## 当gdb命令为：riscv64-unknown-linux-gnu-gdb images/sel4test-driver-image-riscv-spik



```
info files
```

![image-20220323231315617](images/3.23-TODO-seL4-rv_x86%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90.assets/image-20220323231315617.png)

qemu模拟spike时，打印的启动信息如下，也就是说，这里只负责一部分。

![image-20220404111958559](images/4.4-TODO-seL4-rv_x86%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90.assets/image-20220404111958559.png)

`readelf -e sel4test-driver-image-riscv-spike` 查看文件信息：[ELF文件格式与readelf命令使用 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/62039158)。

![image-20220324102523944](images/3.23-TODO-seL4-rv_x86%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90.assets/image-20220324102523944.png)

入口点信息，设置断点：

```
b *0x80000000
```

再输入几个n，就跑起来了：

![img](images/4.4-TODO-seL4-rv_x86%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90.assets/Q%608%25%254J%25@(GPIAA)J$CBFQ.png)

直接打断点到init_kernel，找不到函数，猜测这部分程序只有类似bios的功能，其他模块（0x84000000以后的部分）需要后续装载。

![img](images/4.4-TODO-seL4-rv_x86%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90.assets/4%608T7VS_%7DDLYK27(@P46)9R.png)

在424行：	call	sbi_init，跳到sbi_init函数，在tools/opensbi/lib/sbi/sbi_init.c。

![image-20220404120439306](images/4.4-TODO-seL4-rv_x86%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90.assets/image-20220404120439306.png)

## 当gdb命令为riscv64-unknown-linux-gnu-gdb apps/sel4test-driver/sel4test-driver

此时应该是与测试程序有关，起始地址在用户空间处。

![image-20220404150815054](images/4.4-TODO-seL4-rv_x86%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90.assets/image-20220404150815054.png)

## 当gdb命令为riscv64-unknown-linux-gnu-gdb elfloader/elfloader

暂时不知道这片地址。

![image-20220404151526716](images/4.4-TODO-seL4-rv_x86%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90.assets/image-20220404151526716.png)



## 当gdb命令为riscv64-unknown-linux-gnu-gdb kernel/kernel.elf

![image-20220404151831808](images/4.4-TODO-seL4-rv_x86%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90.assets/image-20220404151831808.png)

此处只有虚拟地址，但虚拟地址格式是我们一直说的位置。

虚拟地址不能直接打断点，此处

```
b init_kernel
```

head.S中，关于.option的部分

![image-20220404155232968](images/4.4-TODO-seL4-rv_x86%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90.assets/image-20220404155232968.png)



























