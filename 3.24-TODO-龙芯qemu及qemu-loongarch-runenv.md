# 安装龙芯的qemu

[qemu linux 命令 在线中文手册 (51yip.com)](http://linux.51yip.com/search/qemu)。

参考网址：

* [qemu/target/loongarch at tcg-dev · yangxiaojuan-loongson/qemu (github.com)](https://github.com/yangxiaojuan-loongson/qemu/tree/tcg-dev/target/loongarch)。
  * 装qemu时：需要下载他给的tcg-dev版本，或者git clone仓库再切换分支，注意其他分支是没有loongarch架构的。用户态，安装，然后暂时可以运行。系统态，从他给的binary仓库中好像有问题，老师在解决。
* https://github.com/sunhaiyong1978/CLFS-for-LoongArch/blob/main/Qemu_For_LoongArch64-Simple.md。
  * 这里面只有用户态。然后挺复杂？

ftp://182.92.153.183/uploads/qemu/clfs.img.xz，下载解压后，参考ftp://182.92.153.183/uploads/qemu/run-clfs.sh启动模拟器，可以进行系统，root密码为loongson。目前还有个小问题，systemd-resolved启动报错，不过重试几次后系统会放弃不影响启动。



这个系统是https://github.com/sunhaiyong1978/CLFS-for-LoongArch/，龙芯孙海勇做的从头构建linux的系统，他还写了一本手把手教clfs的书，有兴趣也可以去看看

Loongarch的操作系统开源的有loongnix（loongnix.cn），阿里的龙蜥和华为欧拉社区也在加入支持；商业的有麒麟和统信等。不过目前有个困难：loongarch的工具链ABI接口还在变化，和现有商业的不完全一致，目前最新的社区linux内核、工具链和bios并不兼容已有的loongnix和商业系统，可能会带来一些额外的麻烦。我这几天组织相关人员把模拟器上的一整套系统从源代码到二进制重新整理一遍，写个更系统些的文档供大家参考



上午那个clfs个头太大，刚刚基于busybox做了一个ramdisk，常见的命令都有才1M多，已经上传到ftp server 182.92.153.183的uploads/qemu/initrd.img, 相应的启动命令参考同目录的run.sh（具体路径可能需要根据自己的配置修改下）



制作方法参考：https://gist.github.com/chrisdone/02e165a0004be33734ac2334f215380e



# qemu-loongarch-runenv

关于efi uefi bios：[IT之家学院：BIOS、EFI与UEFI详解 - IT之家 (ithome.com)](https://www.ithome.com/html/win10/318460.htm)。

一个比较完整的os内核调试环境来了：https://github.com/foxsen/qemu-loongarch-runenv.git

clone仓库

```
git clone https://github.com/foxsen/qemu-loongarch-runenv.git
cd qemu-loongarch-runenv
```

用file命令查看vmlinux信息如下，这说明龙芯可以启动64位elf格式的内核。

![image-20220312093948962](images/3.11-TODO-%E9%BE%99%E8%8A%AFqemu%E5%8F%8Aqemu-loongarch-runenv.assets/image-20220312093948962.png)

直接运行：

```
./run_loongach.sh
```

成功运行：

![image-20220312104451703](images/3.11-TODO-%E9%BE%99%E8%8A%AFqemu%E5%8F%8Aqemu-loongarch-runenv.assets/image-20220312104451703.png)

但是这里的linux内核没有debug信息，如何在编译内核时保留debug信息呢？

# loongson工具链

![image-20220313101204022](images/3.11-TODO-%E9%BE%99%E8%8A%AFqemu%E5%8F%8Aqemu-loongarch-runenv.assets/image-20220313101204022.png)



下载复制到/opt，解压：

```
sudo xz -d loongarch64-clfs-2021-12-18-cross-tools-gcc-full.tar.xz
sudo tar -xvf loongarch64-clfs-2021-12-18-cross-tools-gcc-full.tar
```

将/opt/cross-tools/bin添加到环境变量

```
sudo vim ~/.bashrc #文件尾添加 export PATH=/opt/cross-tools/bin:$PATH
source ~/.bashrc
echo $PATH
/opt/cross-tools-1218/bin/loongarch64-unknown-linux-gnu-gcc -v#查看版本，是12.0.0
```

由于静态链接，做以下工作：

```shel
sudo rm -f /opt/cross-tools/lib/bfd-plugins/libdep.so
```

**在make之前，需要在shell中，此处不再作为永久设置的环境变量。**

```
export LC_ALL=C
export LANG=C
export LANGUAGE=C
```



# 交叉编译linux内核

[linux内核编译与调试方法 - Casualet - 博客园 (cnblogs.com)](https://www.cnblogs.com/syw-casualet/p/5271369.html)。

```
git clone https://github.com/foxsen/linux.git#clone linux repo with loongarch branch
git checkout loongarch-qemu
```

增加交叉编译工具的环境变量。这里只设置成在当前终端有效，在linux目录下，创建setloongarchenv.sh，写入如下脚本。

```
#!/bin/sh
set -x


CC_PREFIX=/opt/cross-tools
export PATH=$CC_PREFIX/bin:$PATH
export LD_LIBRARY_PATH=$CC_PREFIX/lib:$LD_LIBRARY_PATH
export LD_LIBRARY_PATH=$CC_PREFIX/loongarch64-unknown-linux-gnu/lib/:$LD_LIBRARY_PATH

export ARCH=loongarch
export CROSS_COMPILE=loongarch64-unknown-linux-gnu-


#此处也必须把上文中的临时设置环境变量写上
export LC_ALL=C
export LANG=C
export LANGUAGE=C
set +x
```

[linux 下的 source,sh,./三者区别_lihuaichen的博客-CSDN博客_source和sh区别](https://blog.csdn.net/lihuaichen/article/details/94381785)。

注意不要使用`./setloongarchenv.sh`，而是使用：

```
source setloongarchenv.sh
```

回到linux目录下，

```
cp arch/loongarch/configs/loongson3_defconfig_qemu .config
make menuconfig
```

![image-20220313142524839](images/3.11-TODO-%E9%BE%99%E8%8A%AFqemu%E5%8F%8Aqemu-loongarch-runenv.assets/image-20220313142524839.png)

出现如下界面：

![image-20220312143744264](images/3.11-TODO-%E9%BE%99%E8%8A%AFqemu%E5%8F%8Aqemu-loongarch-runenv.assets/image-20220312143744264.png)

选择kernel hacking

![image-20220312144009329](images/3.11-TODO-%E9%BE%99%E8%8A%AFqemu%E5%8F%8Aqemu-loongarch-runenv.assets/image-20220312144009329.png)

选择compile-time checks and compile options：

![image-20220312144108206](images/3.11-TODO-%E9%BE%99%E8%8A%AFqemu%E5%8F%8Aqemu-loongarch-runenv.assets/image-20220312144108206.png)

选择compile the kernel with debug info：

![image-20220312144148326](images/3.11-TODO-%E9%BE%99%E8%8A%AFqemu%E5%8F%8Aqemu-loongarch-runenv.assets/image-20220312144148326.png)

然后，发现这里不用save，所以直接退出不保存就好了。

接下来，make

```
make -j8
```

在linux目录下，生成vmlinux是300+M的文件，将其复制到qemu-loongarch-runenv/，注意修改后缀名，这是带调试信息的vmlinux

```
cp ${yourpath}/linux/vmlinux vmlinux.sym
```

# 龙芯版gdb

解压`loongarch-cross-gdb_v12.0.50.20220221-git.tar.bz2`至/opt

```
sudo tar -xjvf loongarch-cross-gdb_v12.0.50.20220221-git.tar.bz2 -C /opt/
```

添加环境变量到文件/etc/profile，重启

```
export PATH=/opt/gdb/bin:$PATH
```

在qemu-loongarch-runenv下，打开终端：

```
./run_loongach.sh -k vmlinux.sym -D
```

在另一个终端下，用龙芯gdb打开，此处最好是在linux目录下，毕竟调试时涉及的目录也在那里。

```
loongarch64-unknown-gnu-gdb vmlinux
(gdb)target remote:1234
(gdb)b start_kernel
(gdb)c
```

![image-20220313155318199](images/3.11-TODO-%E9%BE%99%E8%8A%AFqemu%E5%8F%8Aqemu-loongarch-runenv.assets/image-20220313155318199.png)

# 关于龙芯内核启动

## 龙芯内核入口地址

通过如下命令查看：`readelf -h vmlinux`

![image-20220324191520385](images/3.24-TODO-%E9%BE%99%E8%8A%AFqemu%E5%8F%8Aqemu-loongarch-runenv.assets/image-20220324191520385.png)

![image-20220324191500246](images/3.24-TODO-%E9%BE%99%E8%8A%AFqemu%E5%8F%8Aqemu-loongarch-runenv.assets/image-20220324191500246.png)

## 龙芯head.S分析

见新增代码文件。











