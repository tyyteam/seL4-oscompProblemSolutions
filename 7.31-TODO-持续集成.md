# CI、CDE、CD定义

> **continuous integration** (**CI**) is the practice of merging all developer working copies to a shared mainline several times a day.

与持续交付CD，持续部署CD的区别及解析，有图加以说明：https://blog.csdn.net/xp178171640/article/details/124379156

持续交付CD(CDE)：重点在于在较短的周期中发布软件产品，保证软件可以在任何时间交付，但是手动发布软件。**确保新增的代码在生产环境中是可用的** 。

持续部署CD：通过自动化部署的手段将软件功能频繁的进行交付。从开发人员提交代码到编译、测试、部署的全流程不需要人工的干预。

# CI的条件

* **版本控制系统工具**：如git
* **构建工具**：处理应用的源代码，自动生成所需的软件
* **神器库管理器（Artifacts Repository Manager）**:

[SonarQube](https://www.sonarqube.org/) 代码质量管理，可以与主流CI工具集成。

# CI成熟工具：

**Jenkins**，**Travis CI**，**CircleCI**，**Bamboo**等

# github的workflow

https://docs.github.com/cn/actions

https://bbs.huaweicloud.com/blogs/331234

当指定发生拉取或推送操作时，触发 GitHub CI 服务器，执行由一个或多个 actions 组合到一起的 workflow 工作流程。



# seL4的github workflow

docker hub 仓库的替换

| seL4 docker仓库名              | tyyteam docker仓库名             |
| ------------------------------ | -------------------------------- |
| trustworthysystems/sel4:latest | gootal/la-sel4:latest            |
| sel4/cparser-run:latest        | gootal/la-cparser-run:latest     |
| sel4/cparser-builder:latest    | gootal/la-cparser-builder:latest |

使用了seL4/ci-citations库，已将其fork到tyyteam下。

## manual.yml

用于自动生成manual.pdf，可以在actions对应的workflow下载文件。它根据已写好的tex文件生成文档，不会根据代码自动生成文档。

## compilation-checks.yml

该文件引用了单独编译kernel的workflow。



在当前compilation-checks.yml文件matrix下增加Loongarch64支持，在compiler里去掉llvm。

compilation-checks.yml文件修改为引用la-seL4-ci-actions库的standalone-kernel的action.yml脚本。

standalone-kernel的action.yml脚本，规定了输入内容和运行的Dockerfile。

Dockerfile引用了[docker hub网站](hub.docker.com)上的文件trustworthysystems/sel4，改为引用gootal/la-sel4:latest。并设置compile_kernel.sh文件为入口，该文件增加了对Loongarch64的支持。

在[docker hub网站](hub.docker.com)上搜索到trustworthysystems/sel4，可以找到生成该镜像的github仓库seL4-CAmkES-L4v-dockerfile。将其fork到tyyteam。在build.sh的-b选项中增加sel4_la的build选项，我们以trustworthysystems/sel4为基础，build出gootal/la-sel4:latest镜像并上传。



一些docker命令：

docker build. -f xxx -t xxx

docker的push命令docker  push gootal/la-sel4:tagname

docker run -it -e DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix gootal/la-sel4:latest



安装配置docker。



## cparser.yml(基本完成，还需要修改语法错误)

该文件分析代码是否被SeL4的C语言子集支持。更严格的C语法，为了形式化验证做准备。需要修改多处语法不严格的点。



cparser.yml引用了la-seL4-ci-actions库的cparser-run的action.yml脚本。

- [x] cparser-run的action.yml脚本规定了使用的Dockerfile，来自docker hub上的sel4/cparser-run:latest。将此处修改为自己的docker:/**/gootal/la-cparser-run:latest**，该docker需要根据当前的Makefile进行build。

- [x] Makefile根据Dockerfile build出gootal/la-cparser-run:latest，Dockerfile中还需要**gootal/la-cparser-builder**，和FROM(gootal/la-sel4:latest)，**31行**涉及到seL4-platforms下的脚本需要增加龙芯平台支持。

- [x] la-cparser-builder在仓库的docker/下，Makefile根据**cparser-builder.dockerfile**生成。生成的镜像（35行）仅包含c-parser的内容，在工作目录的/l4v/tools/c-parser/standalone-parser下。

- [x] 在cparser-run/steps.sh中，拉取了最新的脚本，我们需要用自己的仓库覆盖它。因为我们的仓库里才对cmake文件有修改。: 表明后面是表达式，不是命令。repo各个参数：depth用于指定克隆深度，为1即表示只克隆最近一次commit。

  ![image-20220808104154401](images/7.31-TODO-%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90.assets/image-20220808104154401.png)

  repo init --depth=1 -m master.xml -b master -u "https://github.com/seL4/sel4test-manifest.git" --repo-url=https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/。我们需要换成kernel-dev，projects下面的

- [ ] 在仓库的docker/cparser-builder.dockerfile,15行需要龙芯版的l4v image，35行c-parser的内容需要添加c-parser的Loongarch64支持，(git clone repo用的github连接，可以看到devel.xml中的内容与l4v有关)。24行会拉取l4v仓库，然后28行make standalone-cparser，对应的Makefile在l4v仓库的tools/c-parser/standalone-parser/Makefile中，Makefile添加LoongArch64支持，还要把库换成龙芯的la-l4v。

  ```
  repo init --depth=1 -m devel.xml -b master -u https://github.com/seL4/verification-manifest.git
  ```

  - [ ] 关于第15行的镜像：此处是个trustworthysystems/l4v:latest镜像，需要修改Makefile文件，build出LoongArch64版本(如何build见下文)，再上传gootal/la-l4v。

    - [ ] 关于生成gootal/la-l4v：在trustworthysystems/l4v:latest镜像的docker hub说明由seL4-CAmkES-L4v-dockerfiles 生成，有build_l4v函数，考虑加入龙芯版的l4v，在build_l4v最终会调用scripts下的l4v.sh，在其中的repo模块拉取la-l4v。增加build_l4v_la()，调用l4vla.Dockerfile，再调用scripts/l4v.sh，覆盖其l4v。根据readme，命令行输入./build.sh -b l4v_la

      - [ ] 调用scripts/l4vla.sh时，make sandbox时，执行l4v/spec/haskell下的Makefile，更新cabal有问题。本地安装cabal并更新也很慢，直接删掉cabal v2-update，修改其Makefile文件。找到问题，因为没有管理员权限。将大的文件拆分成3个脚本文件，利用docker的cache，减少出错。下图是容易下载出错的包。终于成功编译出la-l4v:latest docker。

- [ ] 修改la-l4v仓库：tools/c-parser下的Makefile，各种细节，还有umm_heap下缺Loongarch64文件夹

没有通过语法检查，当前workflow检查的是哪个仓库，tyyteam的la-seL4库





遇到一些docker问题。docker配置代理，配置dockerd和container代理。docker重启有问题时，用ps -ef|grep docker查看并杀死docker相关进程，重启机器再重启docker。



### 需要解决的错误

![image-20220812140431484](images/7.31-TODO-%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90.assets/image-20220812140431484.png)

### 已解决的语法问题

kernel/src/arch/loongarch/kernel/vspace.c switch case在default之前没有return问题。

## pr.yml

pull request触发

分为多个job：

* gitlint：commit规范。

* whitespace：句子末尾多空格或tab的检查。

* shell：shell脚本可移植性检查。

* style：代码风格检查？

* preprocess：预处理？



## preprocess-deploy.yml

push时触发

分为多个job：

* Code Freeze：冻结仓库现场？
* preprocess：预处理？
* deploy: deploy new verification manifest



## proof.yml

证明的检查？



## push.yml（待做）

* License Check：检查当前仓库的license。

- [ ] la-seL4/.github/workflows/
  - [ ] push.yml 修改19行的引用
- [ ] la-seL4-ci-actions/
  - [ ] license-check/
    - [ ] 检查有无license和copy right信息

* Links：检查html或markdown文档里的链接是否有效

- [ ] la-seL4/.github/workflows/

  - [ ] push.yml 修改25行的引用

- [ ] 修复如下文档链接问题：

  ![image-20220813143958457](images/7.31-TODO-%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90.assets/image-20220813143958457.png)



## sel4test-deploy.yml

比较复杂



## sel4test-hw.yml 

复杂



## sel4test-sim.yml(待做)



## trigger.yml(待做)

暂时不打算移植该workflow。因为某个仓库发生修改后，它会通知所有manifest中包含该仓库的manifest测试仓库跑测试程序，我们还有很多仓库没有移植。

Trigger repository dispatch on main test repos。seL4中有很多repo manifest，每个manifest通常有个主测试套件，可能运行在某个repo上。某些仓库可能是多个manifest共同拥有的。修改某个仓库可能影响多个manifest。为了避免重复地在多个manifest上执行测试，trigger action会通知某个具体的仓库去运行测试程序。

接收参数：

push代码到master触发

- [ ] la-seL4仓库
  - [ ] /.github/workflows/trigger.yml。15行：owner后期可能要改成tyyteam。18行uses：改成tyyteam
- [ ] la-ci-actions/
  - [ ] /trigger/
    - [ ] action.yml引用../js/index.js，../js/index.js引用run.js。run.js设置了scripts路径。
    - [ ] steps.sh运行dispatch.py
    - [ ] dispatch.py调用notify.yml通知其他仓库。







## xml_lint.yml(待做)











# seL4可以做什么？

- [x] commit规范？https://cloud.tencent.com/developer/article/1598663。

  自己做模板，目前使用angular的模板。

可以sonarQube做QA?

查阅github workflow做CI的方法。



用actions同步github仓库到gitlab？



# 参考：

https://zhuanlan.zhihu.com/p/52197714

