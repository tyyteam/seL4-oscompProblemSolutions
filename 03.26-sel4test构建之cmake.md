# sel4test-riscv构建cmake相关解析

## 文件夹初始化

`mkdir build`

`cd build`

`../init-build.sh -DPLATFORM=spike -DRISCV64=1 -DSIMULATION=1`

这里的命令等价于：

`cmake -G Ninja -DPLATFORM=spike -DRISCV64=1 -DSIMULATION=1 -DSEL4_CACHE_DIR=../.sel4_cache -C ../projects/sel4test/settings.cmake ../projects/sel4test`

.sel4_cache文件夹里存了每次构建时的.h文件和.o文件，不知道全不全。

这里引用的CMakeLists位于projects/sel4test, settings.cmake也在这里，外面的文件夹是这个文件的软链接。

## projects/sel4test文件夹

### domain_schedule.c文件

这是一个适用于 sel4test 中的域测试的域计划。为了让测试取得进展，所有 sel4test 实际需要的是每个域在一段时间内可执行。

此文件作为内核的一部分编译，引用内核头文件也是如此 

此文件创建全局数组`const dschedule_t ksDomSchedule[]`,
包含CONFIG_NUM_DOMAINS个域（domin），每个域长这样：`{ .domain = 0, .length = 1 },`
domin为域计划的ID，最多到15，即domin最多16个。CONFIG_NUM_DOMAINS应该是宏定义，但是没找到。
此外还有一个全局变量`const word_t ksDomScheduleLength`表示上面数组的长度。











## projects/sel4test/CMakeLists

`set(KernelRootCNodeSizeBits 13 CACHE INTERNAL "")`设置CNode大小

`sel4_import_kernel()`cmake的宏定义，定义在kernel下的FindseL4.cmake，作用是往当前项目文件夹中构建添加一个子目录，在这之前项目文件夹下只有cmake生成的：
- CMakeCache.txt
- CMakeFiles
- gcc.cmake

执行完这个之后，初始化了kernel的子文件夹。

接下载针对不同架构设置ELFloader

``` cmake
if((NOT Sel4testAllowSettingsOverride) AND (KernelArchARM OR KernelArchRiscV))
    # Elfloader settings that correspond to how Data61 sets its boards up.
    ApplyData61ElfLoaderSettings(${KernelPlatform} ${KernelSel4Arch})
endif()
```
Sel4testAllowSettingsOverride在projects/sel4test/settings.cmake定义，默认OFF，如果ON则允许用户覆盖配置设置。

KernelArchARM和KernelArchRiscV这俩个玩意儿不知道怎么定义的，复杂得很。但是这里能确定的是KernelArchARM用来标记平台是不是ARM，KernelArchRiscV标记是不是RiscV，他把这俩放一块，意思就把RiscV和ARM一起处理？

`ApplyData61ElfLoaderSettings(${KernelPlatform} ${KernelSel4Arch})`这个函数是tools/seL4/cmake-tool/helpers的application_settings.cmake定义的，这里还有`ApplyCommonSimulationSettings`，`correct_platform_strings`和`ApplyCommonReleaseVerificationSettings`。

上面用的函数里有俩个参数，KernelPlatform在这里的值已经是spike，KernelSel4Arch是riscv64。我们要修改为自己的平台架构时要在sel4-test/kernel/configs的cmake文件修改和增加来使得命令行支持，待做。
此时跳到 [tools/seL4/cmake-tool/helpers的application_settings.cmake](#toolssel4cmake-toolhelpersapplicationsettingscmake)函数内部

执行完application_settings.cmake（spike RiscV64只在这个函数设置了ElfloaderImage为默认值）回到CMakeLists，接下来调用在tools/seL4/elfloader-tool下的Finderfloader-tool.cmake定义的函数`elfloader_import_project()`，构建添加一个子目录elfloader

然后再执行`add_subdirectory(apps/sel4test-driver)`


## tools/seL4/cmake-tool/helpers/application_settings.cmake

首先`set(ElfloaderImage "elf" CACHE STRING "" FORCE)`即设置ElfloaderImage为elf。这里的设置是默认设置，在这之前有很多情况，设置的是其他的ElfloaderImage

``` cmake
    set(binary_list "tx1;hikey;odroidc2;odroidc4;imx8mq-evk;imx8mm-evk;hifive;tqma8xqp1gb")
    set(efi_list "tk1;rockpro64")
    set(uimage_list "tx2;am335x")
    if(
        ${kernel_platform} IN_LIST efi_list
        OR (${kernel_platform} STREQUAL "hikey" AND ${kernel_sel4_arch} STREQUAL "aarch64")
    )
        set(ElfloaderImage "efi" CACHE STRING "" FORCE)
    elseif(${kernel_platform} IN_LIST uimage_list)
        set(ElfloaderImage "uimage" CACHE STRING "" FORCE)
        #rpi3
    elseif(${kernel_platform} STREQUAL "bcm2837" AND ${kernel_sel4_arch} STREQUAL "aarch64")
        set(ElfloaderImage "binary" CACHE STRING "" FORCE)
        #rpi4
    elseif(${kernel_platform} STREQUAL "bcm2711" AND ${kernel_sel4_arch} STREQUAL "aarch64")
        set(ElfloaderImage "efi" CACHE STRING "" FORCE)
    elseif(${kernel_platform} IN_LIST binary_list)
        set(ElfloaderImage "binary" CACHE STRING "" FORCE)
    else()
        set(ElfloaderImage "elf" CACHE STRING "" FORCE)
    endif()
```
在sel4-test/kernel/configs/SeL4Config.cmake中有一个宏定义`declare_platform`去注册平台的配置选项，以便在选中时进行设置。函数执行到这里会根据不同的平台选择IMAGE_START_ADDR起始地址，
我们是spike，这里的cmake没有设置IMAGE_START_ADDR。在kernel/src/plat/spike/config.cmake中调用`declare_platform`注册KernelPlatformSpike，下面还有一些执行，需要看看。

回到函数，这里并不满足任何条件，没有设置IMAGE_START_ADDR直接退出了？

注意到如果满足这个条件`if(KernelPlatformSpike AND KernelSel4ArchRiscV32)`就会设置
`set(IMAGE_START_ADDR 0x80400000 CACHE INTERNAL "" FORCE)`.但是这是32位的RiscV。

然后回到projects/sel4test/CMakeLists（往上翻）
[tools/seL4/cmake-tool/helpers的application_settings.cmake](#projectssel4testcmakelists)