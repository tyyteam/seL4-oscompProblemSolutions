# sel4test-riscv构建cmake相关解析

## 文件夹初始化

`mkdir build`

`cd build`

`../init-build.sh -DPLATFORM=spike -DRISCV64=1 -DSIMULATION=1`

这里的命令等价于：

`cmake -G Ninja -DPLATFORM=spike -DRISCV64=1 -DSIMULATION=1 -DSEL4_CACHE_DIR=../.sel4_cache -C ../projects/sel4test/settings.cmake ../projects/sel4test`

.sel4_cache文件夹里存了每次构建时的.h文件和.o文件，不知道全不全。

这里引用的CMakeLists位于projects/sel4test,settings.cmake也在这里，外面的文件夹是这个文件的软链接。

## projects/sel4test文件夹

### domain_schedule.c文件

这是一个适用于 sel4test 中的域测试的域计划。为了让测试取得进展，所有 sel4test 实际需要的是每个域在一段时间内可执行。

此文件作为内核的一部分编译，引用内核头文件也是如此 

此文件创建全局数组`const dschedule_t ksDomSchedule[]`,
包含CONFIG_NUM_DOMAINS个域（domin），每个域长这样：`{ .domain = 0, .length = 1 },`
domin为域计划的ID，最多到15，即domin最多16个。CONFIG_NUM_DOMAINS应该是宏定义，但是没找到。
此外还有一个全部变量`const word_t ksDomScheduleLength`表示上面数组的长度。











## projects/sel4test/CMakeLists

`set(KernelRootCNodeSizeBits 13 CACHE INTERNAL "")`设置CNode大小

`sel4_import_kernel()`cmake的宏定义，定义在kernel下的FindseL.cmake，作用是往当前项目文件夹中构建添加一个子目录，在这之前项目文件夹下只有cmake生成的：
- CMakeCache.txt
- CMakeFiles
- gcc.cmake

执行完这个之后，初始化了kernel的子文件夹。

接下载针对不同架构设置ELFloader

```
if((NOT Sel4testAllowSettingsOverride) AND (KernelArchARM OR KernelArchRiscV))
    # Elfloader settings that correspond to how Data61 sets its boards up.
    ApplyData61ElfLoaderSettings(${KernelPlatform} ${KernelSel4Arch})
endif()
```
Sel4testAllowSettingsOverride在projects/sel4test/settings.cmake定义，默认OFF，如果ON则允许用户覆盖配置设置。

KernelArchARM和KernelArchRiscV这俩个玩意儿不知道怎么定义的，复杂得很。但是这里能确定的是KernelArchARM用来标记平台是不是ARM，KernelArchRiscV标记是不是RiscV，他把这俩放一块，意思就把RiscV当成了ARM？

`ApplyData61ElfLoaderSettings(${KernelPlatform} ${KernelSel4Arch})`这个是调用tools/seL4/cmake-tool/helpers的application_settings.cmake定义的此函数，这里还有`ApplyCommonSimulationSettings`，`correct_platform_strings`和`ApplyCommonReleaseVerificationSettings`。

上面的函数里有俩个参数，KernelPlatform在这里的值已经是spike，KernelSel4Arch是riscv64。我们要修改为自己的平台架构时要在/home/leon/download/sel4-test/kernel/configs的cmake文件修改和增加来使得命令行支持，待做。
此时跳到 [tools/seL4/cmake-tool/helpers的application_settings.cmake](##tools/seL4/cmake-tool/helpers的application_settings.cmake)函数内部

## tools/seL4/cmake-tool/helpers的application_settings.cmake

